## 网络层
<!-- TOC -->

- [网络层](#网络层)
- [1.功能 *](#1功能-)
  - [1.异构网络互联 *](#1异构网络互联-)
  - [2.路由与转发](#2路由与转发)
  - [3.SDN基本概念](#3sdn基本概念)
  - [4.拥塞控制](#4拥塞控制)
- [2.路由算法](#2路由算法)
- [3.IPv4 *](#3ipv4-)
  - [1.IPv4分组 *](#1ipv4分组-)
    - [1.IPv4分组格式 *](#1ipv4分组格式-)
    - [2.IP数据报分片 *](#2ip数据报分片-)
  - [2.IPv4地址与NAT *](#2ipv4地址与nat-)
    - [1.IPv4地址 *](#1ipv4地址-)
    - [2.NAT *](#2nat-)
  - [3.子网划分与子网掩码、CIDR *](#3子网划分与子网掩码cidr-)
    - [1.子网划分 *](#1子网划分-)
    - [2.子网掩码 *](#2子网掩码-)
    - [3.无分类编址CIDR *](#3无分类编址cidr-)
    - [4.网络层转发分组](#4网络层转发分组)
  - [4.ARP/DHCP/ICMP](#4arpdhcpicmp)
    - [1.IP地址与硬件地址](#1ip地址与硬件地址)
    - [2.地址解析协议（ARP） *](#2地址解析协议arp-)
    - [3.动态主机配置协议（DHPC）](#3动态主机配置协议dhpc)
    - [4.网际控制报文协议（ICMP） *](#4网际控制报文协议icmp-)
- [4.IPv6](#4ipv6)
  - [1.IP地址耗尽解决方案](#1ip地址耗尽解决方案)
  - [2. IPv6特点](#2-ipv6特点)
- [5.路由协议 *](#5路由协议-)
  - [1.自治系统 *](#1自治系统-)
  - [2.域内路由与域间路由 *](#2域内路由与域间路由-)
    - [1.内部网关协议IGP *](#1内部网关协议igp-)
    - [2.外部网关协议EGP *](#2外部网关协议egp-)
  - [3.路由信息协议RIP *](#3路由信息协议rip-)
    - [1.规定 *](#1规定-)
    - [2.特点 *](#2特点-)
    - [3.距离向量算法 *](#3距离向量算法-)
  - [4.开放最短路径优先OSPF *](#4开放最短路径优先ospf-)
  - [5.边界网关协议BGP](#5边界网关协议bgp)

<!-- /TOC -->
## 1.功能 *
- 只提供`简单灵活的`，`无连接的`，`尽最大努力交付`的数据报服务
- 可能`出错`，`丢失`，`重复`，`失序或超时`，可靠通信由更高层的 **`传输层`** 来完成
- 网络造价`大幅降低`，运行方式`灵活`，能够适用多种应用

### 1.异构网络互联 *
- 网络互联：两个以上的计算机网络，通过一定的方法，用一些中间设备（又称**中继设备**），互相连接起来，以构成更大的网络系统。
- 中继系统分类：
  - `物理层`：转发器，集线器。
  - `数据链路层`：网桥或交换机。
  - `网络层`：路由器
  - `网络层以上`：网关
> 网络互联通常指用`路由器`进行网络互联和路由选择。路由器是一台专用计算机，用于在互联网中进行路由选择。

-  **`TCP/IP`** 体系在网络层采用**标准化协议**，使`异构`的网络通过路由器可以使用`相同`的IP协议，使之互联后可被视为`一个虚拟IP网络`。
-  **`虚拟互联网络`** :也称为`逻辑互联网络`，指物理网络的**异构性**通过`IP协议`使之在网络层看起来像一个统一的网络，这种虚拟互联网络简称为`IP网络`。
- 优点：互联网上主机通信，就如同在一个网络上通信，看不到互联网各个网络具体异构细节。

### 2.路由与转发
- **`路由选择`** ：根据特定的路由选择协议构造`路由表`，同时按照复杂的`分布式算法`，经常/定期和相邻路由器交换路由信息而不断`更新维护路由表`，从而`动态`地改变所选择的路由。
- **`分组转发`** ：路由器根据`转发表查询`，将用户的IP数据报从合适的端口`转发`出去。

### 3.SDN基本概念
- 网络层可以抽象地划分为`数据封面`和`控制层面`，前者实现**转发**的功能，后者实现**路由选择**的功能
- **`软件定义网路(SDN)`** ：采用**集中式的控制层面**和**分布式的数据层面**
- 在控制层面有一个逻辑上的**远程控制器**，掌握各个主机和整个网络的状态，为每个分组计算出最佳路由，通过`Openflow`协议将转发表下发给`路由器`
- 路由器只需要`收到分组`，`查找转发表`，`转发分组`
- SDN优点：
  - `全局集中式控制和分布式高速转发`，既有利于**控制层面全局化**，又利于**高性能的网络转发**。
  - `灵活可编程与性能的平衡`，控制和转发功能分离后，使得网络可以由专有的自动化工具**以编程方式配置**。
  - `降低成本`，控制和数据层面分离后，尤其是在使用开放的接口协议后，就实现了**网络设备的制造与功能软件的开发相分离**，从而有效降低了成本。
- SDN问题：
  - `安全风险`，集中管理**容易受攻击**，如果崩溃，整个网络会受到影响。
  - `瓶颈问题`，原本分布式的控制层面集中化后，随着网络规模扩大，控制器可能成为网络性能的瓶颈。
### 4.拥塞控制
- 在通信子网中，因出现过量分组而引起网络性能下降的现象称为 **`拥塞`**
- `判断拥塞`：观察`网络吞吐量`与`网络负载`。如果负载增加，网络吞吐量明显小于正常吞吐量，则进入**轻度拥塞**；网络吞吐量随负载增加而下降，则网络可能已经进入**拥塞状态**；如果吞吐量降为0，则网络可能已经进入**死锁状态**
-  **`拥塞控制`** 的作用是确保子网能承载所能达到的流量，这是一个**全局性的过程**，设计各方面的行为；单一地增加资源并不能解决拥塞。
- 拥塞控制两种方法：
  - **`开环控制`** ：在设计网络时**事先将有关发生拥塞地因素考虑周到**，力求网络在工作时不产生拥塞；这是一种`静态`的预防方法，一旦整个系统启动并运行，中途就不再需要修改。
  - **`闭环控制`** ：事先不考虑有关发生拥塞的各种因素，采用image.png，及时检测哪里出现了拥塞，然后将拥塞信息传到合适的地方，以便调整网络系统的运行，并解决出现的问题。闭环控制是基于反馈环路的概念，是一种`动态`的方法。
## 2.路由算法











## 3.IPv4 *
### 1.IPv4分组 *
**`IPv4`** ：IP协议版本4，定义了`数据传送的基本单元`——`IP分组`及其确切的数据格式，以及一整套规则，指明分组如何处理、错误怎样控制等。

#### 1.IPv4分组格式 *

- IP分组由`首部`和`数据部分`组成。首部前一部分长度固定，共 $20B$，是所有IP分组必须有的。
- 首部固定部分后面是一些`可选字段`，这些字段的长度是**可变**的，也可以没有。
- 首部重要字段：
  - **`版本`** ：**4位**，IP协议的版本，IPv4为 $4$ ，IPv6为 $6$ ，目前广泛使用的版本号是 $4$
  - **`首部长度`** ：**4位**，以32位为单位，最大值为 $15×4B=60B$ ，最常用首部长度为 $20B$
  - **`区分服务（TOS）`** ：**8位**，服务类型，用于区分不同的服务，包括 $3$ 位的优先权字段（取值可以从 $000-111$ 所有值）， $4$ 位的TOS子字段和 $1$ 位的未用位但必须置 $0$
  - **`总长度`** ：**16位**，IP分组的总长度，即首部和数据之和的长度，单位为**字节**，因此数据报最大长度为 $2^{16}-1=65535B$
  - **`标识`** ：**16位**，计数器，产生**数据报**就加一。用于**数据报分片**时标识分组，以便分组重组。
  - > 注： **`标识`** 不是 **`序号`** ，因为IP是 **`无连接`** 的，不保证数据报的顺序。
  - **`标志`** ：**3位**，目前只有两位有效，最低位 **`MF`（More Fragment）** 和第二位 **`DF`（Don't Fragment）** ，用于**数据报分片**。
  - **`片偏移`** ：**13位**，分片后某片的偏移量，片偏移以 $8B$ 为偏移单位。除最后一个分片外，每个分片的长度都是 $8B$ 的整数倍
  - **`生存时间（TTL）`** ：**8位**，数据报在网络中可通过**路由器的最大值**，标识分组在网络中的寿命，确保分组不会在网络中永远循环；每经过一个路由器，**TTL减一**，当TTL为0时，分组被**丢弃**。
  - **`协议`** ：**8位**，协议字段，即分组的数据部分上交给哪个协议进行处理，如 $6$ 代表 **`TCP`** ， $17$ 代表 **`UDP`** ， $1$ 代表 **`ICMP`** 。
  - **`首部校验和`** ：**16位**，用于检验**首部**是否出错
  - **`源IP地址`** ：**32位**，用于标识发送方主机
  - **`目的IP地址`** ：**32位**，用于标识接收方主机

#### 2.IP数据报分片 *
- 一个链路层数据报能承载的最大数据量称为 **最大传送单元`MTU`** 
- 链路层的MTU严格地限制着**IP数据报的长度**，各段链路可能使用不同的链路层协议，故其MTU也不同，例如以太网MTU为 $1500B$ ，许多广域网的MTU不超过 $576B$
- 当IP数据报总长度大于MTU时，就需要对数据报进行**分片**，以便于传输；较小的数据报就称为 **`片`**
- 每个数据片都要添加相应的首部；其标识号为**原始的标识号**，片偏移量为该片相对于原始数据报的**偏移量**。
- 在标志位中，**DF=0**，表示可以分片；DF=1，表示不允许分片；**MF=0**，表示最后一个分片；**MF=1**，表示不是最后一个分片
### 2.IPv4地址与NAT *

#### 1.IPv4地址 *
- 连接到Internet的每台主机/路由器都分配一个32bit的**全球唯一标识符**，即`IP地址`。
- 互联网早期采用的是分类的IP地址


-  **`IP地址::={<网络号>,<主机号>}`** ，网络号标志主机/路由器连接到的网络。主机号标志主机/路由器。
- 网络号在整个Internet范围内**唯一**，主机号在网络号指明的网络内**唯一**。
- 特殊的IP地址：
  -  **主机号全为0** ：本网络本身
  -  **主机号全为1** ：本网络广播地址，又称直接广播地址
  -  **127.x.x.x** ：保留为环回自检地址，表示任意主机本身，目的地址为环回地址的IP数据报永远不会出现在任何网络上
  -  **0.0.0.0** ：网络上的本主机
  -  **255.255.255.255** ：整个TCP/IP网络的广播地址，又称受限广播地址。实际使用中，由于路由器对广播域的隔离，其等效为本网络的广播地址。
- 三类IP地址使用范围

|类别|最大可用网络数目|第一个网络号|最后一个网络号|每个网络最大主机数|
|---|---|---|---|---|
| $A$ | $2^{7}-2$ | $1$ | $126$ | $2^{24}-2$ |
| $B$ | $2^{14}$ | $128.0$ | $191.255$ | $2^{16}-2$ |
| $C$ | $2^{21}$ | $192.0.0$ | $223.255.255$ | $2^{8}-2$ |

- A类少了网络号为**0和127**，主机数少了主机号**全为0和全为1**

- IP地址特点
  - IP包含网络号和主机号，因此IP地址是一种分等级的地址结构。其优点有
    - IP地址管理机构分配IP只分配网络号，主机号则由网络的单位自行分配，方便IP管理。
    - 路由器仅仅根据目的主机所连接的网络号来转发分组，减少路由表所占存储空间。
  - IP地址是标识一台主机/路由器和一条链路的接口。因此IP网络上的一个路由器必然至少拥有两个IP地址。
  - 用转发器/网桥等

#### 2.NAT *
- NAT将专用网络地址转换为公用网络地址，从而对外隐藏内部管理的IP地址，使得专用网只需要一个全球IP就可以与因特网连接
- NAT大大节省了IP地址的消耗，隐藏内部网络结构，降低了内部网络受到攻击的风险。
- 划分私有IP地址，使其只能用于LAN内部，不允许出现在因特网上
  - **`A类`** ：**1个**A类网段，即**10.0.0.0~10.255.255.255**
  - **`B类`** ：**16个**B类网段，即**172.16.0.0~172.31.255.255**
  - **`C类`** ：**256个**C类网段，即**192.168.0.0~172.168.255.255**
- 路由器对目的地址为私有地址的数据报**不进行转发**。采用私有IP地址的互联网称为**专用互联网/本地互联网**，私有IP地址称为**可重用地址**
- NAT路由器使用`NAT表`将本地IP地址和全球IP地址进行转换，由此可以将多个私有IP地址**映射**到一个全球IP地址。

### 3.子网划分与子网掩码、CIDR *
#### 1.子网划分 *
- `原因`：两级IP地址空间利用率很低，不够灵活
- `方法`：将一个网络划分为多个子网，IP地址中添加子网号字段，使两级IP地址变为**三级IP地址**。
- 基本思路：
  - 子网划分对外部网络是透明的，对内部网络是可见的。
  - 从主机号借用若干比特作为子网号，主机号的位数减少，三级IP地址的结构 **`IP地址={<网络号>,<子网号>,<主机号>}`**
  - 由于子网号是在原先主机号内划分的，因此不影响其他网络发来的IP数据报的路由转发。

#### 2.子网掩码 *
- `子网掩码`：32位，一串1后面跟着一串0。1对应**网络号**和**子网号**，0对应**主机号**。
- 计算机只需要将IP地址和子网掩码**按位与运算**，即可获得子网的网络地址。
- 一台主机设置IP地址信息的同时，必须设置子网掩码。
- 同属于一个子网的所有主机和路由器的相应端口，必须设置相应的子网掩码
- 路由器的路由表中，包含信息的主要内容有目的网络地址，子网掩码，下一跳地址。

#### 3.无分类编址CIDR *
-  **`CIDR`** 消除了传统ABC类地址及划分子网的概念，因而可以更有效地分配IPv4的地址空间。
-  **`CIDR`** 使用**长度可变**的**网络前缀**的概念代替子网的概念，即 **`IP::={<网络前缀>，<主机号>}`**
- 采用**斜线记法**（CIDR记法），即IP地址/网络前缀所占比特数，等效于子网掩码中**1的个数**。
- 把网络前缀相同的连续IP组成CIDR地址块，这种地址聚合称之为路由聚合，或称构成**超网**。
- CIDR的优点在于**网络前缀长度的灵活性**，可以通过**延长网络前缀**的方式灵活地划分子网。
-  **`最长前缀匹配`**：使用CIDR时，路由表中每个项目由**网络前缀**和**下一跳地址**组成。在查找路由表时选择具有**最长网络前缀**的路由。
- 搜索方式：**二叉搜索**

#### 4.网络层转发分组

### 4.ARP/DHCP/ICMP

#### 1.IP地址与硬件地址

#### 2.地址解析协议（ARP） *
#### 3.动态主机配置协议（DHPC）
#### 4.网际控制报文协议（ICMP） *

## 4.IPv6
<font size="1">内容很少，学校老师说考研也不考，所以不讲，但我不知道为啥这个内容在王道考研上QAQ</font>

### 1.IP地址耗尽解决方案
- 采用无类别编址 **`CIDR`** ，使IP地址分配更加合理
- 采用网络地址转换 **`NAT`** 节省全球IP地址
- 采用更大的地址空间的新版本的 **`IPv6`**
  
前两个方案是**节省地址**，延长IPv4地址耗尽时间，第三种方案是**增加地址**，从根本上解决地址耗尽问题。
### 2. IPv6特点
- 更大地址空间：从 **`IPv4`** 的 $32$ 位扩充到 $128$ 位
- 扩展的地址**层次结构**
- 灵活的首部格式，首部长度是 **`8B`** 的整数倍（实际上为固定的 **`40B`** ）
- 改进的选项
- 允许协议继续扩充
- 支持自动配置
- 支持资源预分配
- 不允许分片
- 增大安全性，身份验真和保密功能是IPv6的关键特征

 **`IPv6`** 与 **`IPv4`** 不兼容，但它与几乎所有其他因特网协议兼容。
-  **`IPv6`** 地址用 $16$ 字节表示，地址空间是 **`IPv4`** 的 $2^{96}$ 倍
- 简化分组头，只包含8个域，使路由器能更快的处理分组，改善吞吐率
- 更好地支持选项，必选字段变可选。
- IPv6首部字段：
  - **`版本`** ：**4位**，IP协议的版本 $6$ 
  - **`首部长度`** ：**`0位`**，首部长度**固定40字节**
  - **`区分服务（TOS）`** ：**`0位`**
  - **`通信量类`** ：**`0位`**



## 5.路由协议 *
### 1.自治系统 *
**自治系统（`AS`）**：单一技术管理下的一组路由器，这些路由器使用一种**AS内部/之间**的路由选择协议和共同的度量来确定分组在该**AS内部/之间**的路由。

### 2.域内路由与域间路由 *
自治系统内部路由选择称为 **`域内路由选择`** ，自治系统之间的路由称为 **`域间路由选择`** 。

#### 1.内部网关协议IGP *
- 在一个**自治系统内部**使用的路由选择协议，与互联网中其他自治系统选用什么路由选择**无关**。
- 目前这类路由选择协议使用最多，例如 **`RIP`** 和 **`OSPF`**

#### 2.外部网关协议EGP *
- 源站和目的站在**不同自治系统**中，需要使用**外部网关协议**将路由选择信息传递到**另一个自治系统**中。
- 目前使用最多的外部网关协议是 **`BGP-4`**

### 3.路由信息协议RIP *
#### 1.规定 *
- 网络中每个路由器都要维护**从它自身到其他每个目的网络的距离记录**（即 **`距离向量`** ）
- 距离也称 **`跳数`** ，每经过一个**路由器**，跳数加1
- RIP优先选择**跳数少**的路径
- RIP最多允许**15跳**，超过则表示网络不可达，防止出现`环路`，减少拥塞。所以RIP适用于小型互联网。
- 默认任意两个使用RIP的路由器之间**每30秒广播**一次RIP路由更新信息，做到 **`动态维护`** 路由表。
- RIP中 **`子网掩码`** 必须**相同**。但是RIP2支持 **`变长子网掩码`/`CIDR`**

#### 2.特点 *
- 仅和相邻路由交换信息
- 路由器交换的信息是当前路由器所知道的全部信息，即自己的路由表。
- 按固定时间间隔交换路由信息

#### 3.距离向量算法 *
- RIP通过 **`距离向量算法`** 完成路由表的更新，每隔固定时间，每个路由器把自己的路由表发送给所有相邻的网络。所以，在经过若干轮广播后，所有路由器都知道了整个IP网络的路由表，称RIP **`收敛`** ，且路由表中每个路由器到目标网络一定是**最短的**。

- 路由表项包含 **`<目的网络N，距离d，下一跳路由器地址X>`**

- 步骤如下：
  - 地址为 $X$ 发来的RIP，把所有下一跳地址都修改为 $X$ ，距离 $+1$
  - 对于收到的修改后的RIP：
    - 原来路由表**没有**网络 $N$ ：`添加`该表项
    - 原来路由表中**有** $N$ ：
      - 下一跳**是** $X$ ：`替换`原路由表中项
      - 下一跳**不是** $X$ ：
        - $d$ **小于**路由表距离：`替换`路由表中项
        - $d$ **大于等于**路由表距离：啥也不干
  - 若 $180$ 秒（RIP默认**超时时间**）还未收到相邻路由器的更新路由表，把距离设置为 $16$ ，标记为**不可达路由器**

- RIP**优点**：简单，开销小，收敛快
- RIP**缺点**：
  - 限制网络规模，最大距离 $15$
  - 路由器交换的是**完整路由表**，网络规模越大，开销越大
  - 网络出现故障，出现 **`慢收敛`** 现象，使更新过程收敛时间长。
### 4.开放最短路径优先OSPF *

### 5.边界网关协议BGP
